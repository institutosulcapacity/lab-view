<script>
const svg = document.getElementById("painel");
let fioAtual = null;
let origem = null;

// ligações permitidas
const ligacoesValidas = {
  disjuntor_out: ["contator_in"],
  contator_out: ["temporizador_in"],
  temporizador_out: ["motor_in"]
};

svg.addEventListener("mousedown", e => {
  if(e.target.classList.contains("borne")){
    origem = e.target;
    fioAtual = document.createElementNS("http://www.w3.org/2000/svg","line");
    fioAtual.setAttribute("x1", origem.cx.baseVal.value);
    fioAtual.setAttribute("y1", origem.cy.baseVal.value);
    fioAtual.setAttribute("x2", origem.cx.baseVal.value);
    fioAtual.setAttribute("y2", origem.cy.baseVal.value);
    fioAtual.setAttribute("class","fio");
    svg.appendChild(fioAtual);
  }
});

svg.addEventListener("mousemove", e => {
  if(fioAtual){
    const pt = svg.createSVGPoint();
    pt.x = e.clientX;
    pt.y = e.clientY;
    const pos = pt.matrixTransform(svg.getScreenCTM().inverse());
    fioAtual.setAttribute("x2", pos.x);
    fioAtual.setAttribute("y2", pos.y);
  }
});

svg.addEventListener("mouseup", e => {
  if(fioAtual){
    if(e.target.classList.contains("borne") && e.target !== origem){
      const origemId = origem.dataset.id;
      const destinoId = e.target.dataset.id;

      if(
        ligacoesValidas[origemId] &&
        ligacoesValidas[origemId].includes(destinoId)
      ){
        fioAtual.setAttribute("x2", e.target.cx.baseVal.value);
        fioAtual.setAttribute("y2", e.target.cy.baseVal.value);
      } else {
        alert("Ligação incorreta");
        fioAtual.remove();
      }
    } else {
      fioAtual.remove();
    }

    fioAtual = null;
    origem = null;
  }
});
</script>
