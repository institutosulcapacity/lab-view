<script>
let conexoes = {};
let selecionado = null;

let circuitoOk = false;
let comandoLigado = false;
let temporizadorAtivo = false;
let timeoutMotor = null;

// --- arrastar fio (mantém igual ao núcleo) ---
const svg = document.getElementById("painel");

svg.addEventListener("mousedown", e => {
  if(e.target.classList.contains("borne")){
    selecionado = e.target;
    fioAtual = document.createElementNS("http://www.w3.org/2000/svg","line");
    fioAtual.setAttribute("x1", selecionado.cx.baseVal.value);
    fioAtual.setAttribute("y1", selecionado.cy.baseVal.value);
    fioAtual.setAttribute("x2", selecionado.cx.baseVal.value);
    fioAtual.setAttribute("y2", selecionado.cy.baseVal.value);
    fioAtual.setAttribute("class","fio");
    svg.appendChild(fioAtual);
  }
});

svg.addEventListener("mousemove", e => {
  if(fioAtual){
    const pt = svg.createSVGPoint();
    pt.x = e.clientX;
    pt.y = e.clientY;
    const pos = pt.matrixTransform(svg.getScreenCTM().inverse());
    fioAtual.setAttribute("x2", pos.x);
    fioAtual.setAttribute("y2", pos.y);
  }
});

svg.addEventListener("mouseup", e => {
  if(fioAtual){
    if(e.target.classList.contains("borne") && e.target !== selecionado){
      conexoes[selecionado.dataset.id] = e.target.dataset.id;
      fioAtual.setAttribute("x2", e.target.cx.baseVal.value);
      fioAtual.setAttribute("y2", e.target.cy.baseVal.value);
      validarCircuito();
    } else {
      fioAtual.remove();
    }
    fioAtual = null;
    selecionado = null;
  }
});

// --- validação do circuito ---
function validarCircuito(){
  circuitoOk =
    conexoes.disjuntor === "contator_in" &&
    conexoes.contator_out === "temporizador_in" &&
    conexoes.temporizador_out === "motor";
}

// --- botão LIGA ---
function ligar(){
  if(!circuitoOk){
    alert("Circuito incorreto");
    return;
  }
  if(comandoLigado) return;

  comandoLigado = true;
  temporizadorAtivo = true;

  const tempo = parseInt(document.getElementById("tempo").value);

  timeoutMotor = setTimeout(()=>{
    if(comandoLigado){
      document.getElementById("motor").classList.add("ligado");
    }
  }, tempo * 1000);
}

// --- botão DESLIGA ---
function desligar(){
  comandoLigado = false;
  temporizadorAtivo = false;

  if(timeoutMotor){
    clearTimeout(timeoutMotor);
    timeoutMotor = null;
  }

  document.getElementById("motor").classList.remove("ligado");
}

// --- reset geral ---
function resetar(){
  desligar();
  conexoes = {};
  circuitoOk = false;

  document.querySelectorAll(".fio").forEach(f=>f.remove());
}
</script>
